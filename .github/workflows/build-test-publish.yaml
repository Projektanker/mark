name: 🛠️ Build, 🧪 Test, 🚀 Publish

on:
  push:

env:
  DOCKER_USERNAME: projektanker
  DOCKER_IMAGE: projektanker/mark

jobs:
  build-test-publish:
    name: 🛠️ Build, 🧪 Test, 🚀 Publish
    runs-on: ubuntu-latest

    steps:
      - name: 🛒 Checkout
        uses: actions/checkout@v3

      - name: 🐋 Build Docker image
        run: docker build . --file Dockerfile --tag ${{ env.DOCKER_IMAGE }}:latest

      - name: 🧪 Integration test
        working-directory: ./integration-test
        run: |
          docker run --name="test" -d -p="8080:8080" ${{ env.DOCKER_IMAGE }}:latest
          sleep 5
          curl -F "files=@metadata.yaml" -F "files=@template.zip" -o test.pdf http://localhost:8080/api/pdf
          docker logs test > docker.log

      - name: 📤 Upload test artifacts
        uses: actions/upload-artifact@v3
        with:
          name: integration-test
          retention-days: 1
          path: |
            ./integration-test/test.pdf
            ./integration-test/docker.log

      - name: 🏷️ Tag docker image
        if: ${{ startsWith(github.ref_name, 'v') }}
        run: |
          readarray -d . -t TAG <<< ${{ github.ref_name }}
          echo "MAJOR: ${TAG[0]}; MINOR: ${TAG[1]}; PATCH: ${TAG[2]}"
          docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:${TAG[0]}
          docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:${TAG[0]}.${TAG[1]}
          docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:${TAG[0]}.${TAG[1]}.${TAG[2]}

      - name: 📜 List docker images
        run: docker image ls

      - name: 🗝️ Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin

      - name: 🚀 Push to Docker Hub
        if: ${{ startsWith(github.ref_name, 'v') }}
        run: docker push --all-tags ${{ env.DOCKER_IMAGE }}

      - name: 🚪 Logout
        if: always()
        run: docker logout
